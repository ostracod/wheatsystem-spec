<html>
    <head>
        <style>

body {
    padding: 20px;
    font-family: "Times New Roman", Times, serif;
    font-size: 16px;
}

a {
    color: #000000;
}

.title1, .title2 {
    font-family: Arial;
    font-weight: bold;
}

.title1 {
    font-size: 28px;
}

.title2 {
    font-size: 20px;
}

.code {
    font-family: "Courier New", Courier, monospace;
    font-weight: bold;
    font-size: 14px;
    background: #DDDDDD;
    border-radius: 3px;
    padding-left: 2px;
    padding-right: 2px;
}

pre.code {
    padding: 5px;
    width: 500px;
}

.description {
    margin-left: 25px;
}

        </style>
    </head>
    <body>
        <p class="title1">WHEATBYTECODE 1.0.0 DOCUMENTATION</p>
        <p style="color: #CC0000;">(Rough Draft)</p>
        <p>This page was generated from <a href="https://github.com/ostracod/wheatsystem-spec">https://github.com/ostracod/wheatsystem-spec</a> at {TIMESTAMP}.</p>
        <p>WheatBytecode is the programming language provided by WheatSystem for applications. This document describes the syntax and instructions of WheatBytecode.</p>
        <p class="title2">DATA TYPES AND STRUCTURES</p>
        <p>All integers in WheatBytecode are stored in little-endian order. All signed integers use two's complement to express negative values.</p>
        <p>List of primitive data types:</p>
        <ul>
            <li><span class="code">u8</span> = Unsigned 8-bit integer</li>
            <li><span class="code">u32</span> = Unsigned 32-bit integer</li>
            <li><span class="code">s8</span> = Signed 8-bit integer</li>
            <li><span class="code">s32</span> = Signed 32-bit integer</li>
        </ul>
        <p>Subcomponents of <span class="code">u8</span>:</p>
        <ul>
            <li><span class="code">u1</span> = Unsigned 1-bit integer</li>
            <li><span class="code">u4</span> = Unsigned 4-bit integer</li>
        </ul>
        <pre class="code">Function table entry = [
    s32 function ID,
    u8 is guarded,
    u32 argument frame size,
    u32 local frame size,
    u32 instruction body file position,
    u32 instruction body size
]</pre>
        <pre class="code">Bytecode application file = [
    u32 global frame size,
    u32 function table length,
    u32 application data file position,
    Function table,
    Instruction array,
    Application data
]</pre>
        <p>File types:</p>
        <ul>
            <li><span class="code">0</span> = Generic file</li>
            <li><span class="code">1</span> = Bytecode application file</li>
            <li><span class="code">2</span> = System application file</li>
        </ul>
        <p class="title2">MEMORY LAYOUT</p>
        <p>Every application has its own stack containing one or more frames. The size of a frame remains fixed after it is allocated.</p>
        <p>Each frame has one of three types:</p>
        <ul>
            <li>The "global frame" is available at all times after launch.</li>
            <li>A "local frame" is available to the current function invocation.</li>
            <li>An "argument frame" is available to both the invoking function and invoked function.</li>
        </ul>
        <p>After the stack is initialized, it contains a single global frame. This frame is never removed.</p>
        <p>To invoke a function, the calling function must perform the following steps:</p>
        <ol>
            <li>Allocate an argument frame.</li>
            <li>Populate the argument frame with arguments.</li>
            <li>Call the function and wait for invocation to finish.</li>
            <li>Read return values from the argument frame.</li>
        </ol>
        <p>An invoked function follows the steps below:</p>
        <ol>
            <li>Read arguments from the argument frame provided by the calling function.</li>
            <li>Perform the desired set of operations.</li>
            <li>Store return values in the argument frame provided by the calling function.</li>
            <li>Return control to the calling function.</li>
        </ol>
        <p>Every application has access to the unified system heap. Heap allocations have fixed size in the same manner as frames. If an application quits, the system will delete every heap allocation created by the application. Otherwise, applications must manually perform garbage collection.</p>
        <p>Applications may reference heap allocations by using pointers. Each pointer is a 32-bit integer generated by the system. The pointer value of the null pointer is zero.</p>
        <p>Every heap allocation may be guarded or unguarded. A guarded heap allocation may only be accessed by its creator or by applications with admin permission.</p>
        <p class="title2">INSTRUCTION SYNTAX</p>
        <pre class="code">Instruction = [
    u8 opcode,
    Array of arguments
]</pre>
        <pre class="code">Argument prefix = [
    u4 reference type,
    u4 data type
]</pre>
        <p>Reference types:</p>
        <ul>
            <li><span class="code">0x0</span> = Constant</li>
            <li><span class="code">0x1</span> = Global frame</li>
            <li><span class="code">0x2</span> = Local frame</li>
            <li><span class="code">0x3</span> = Argument frame provided by calling function</li>
            <li><span class="code">0x4</span> = Argument frame which the next function invocation will receive</li>
            <li><span class="code">0x5</span> = Application data region</li>
            <li><span class="code">0x6</span> = Heap allocation</li>
        </ul>
        <p>Data types:</p>
        <ul>
            <li><span class="code">0x0</span> = <span class="code">s8</span></li>
            <li><span class="code">0x1</span> = <span class="code">s32</span></li>
        </ul>
        <pre class="code">Constant argument = [
    Argument prefix,
    Constant value
]</pre>
        <pre class="code">Frame argument = [
    Argument prefix,
    Frame index as nested argument
]</pre>
        <pre class="code">Application data argument = [
    Argument prefix,
    Application data index as nested argument
]</pre>
        <pre class="code">Heap allocation argument = [
    Argument prefix,
    Pointer as nested argument,
    Allocation index as nested argument
]</pre>
        <p class="title2">SYSTEM ERRORS</p>
        <p><span class="code">genericErr</span> error code = <span class="code">0x00</span></p>
        <div class="description">
            <p>Thrown if a problem occurs which cannot be described by a more specific error code.</p>
        </div>
        <p><span class="code">noImplErr</span> error code = <span class="code">0x01</span></p>
        <div class="description">
            <p>Thrown if no implementation is available for the given operation. This includes the following circumstances:</p>
            <ul>
                <li>The interpreter tries to evaluate an instruction which has an unknown opcode</li>
            </ul>
        </div>
        <p><span class="code">typeErr</span> error code = <span class="code">0x02</span></p>
        <div class="description">
            <p>Thrown if a value or resource has the wrong type. This includes the following circumstances:</p>
            <ul>
                <li>A file has an unexpected type</li>
                <li>An instruction argument has an unknown reference type or data type</li>
                <li>An instruction argument is not constant when a constant value is expected</li>
            </ul>
        </div>
        <p><span class="code">numRangeErr</span> error code = <span class="code">0x03</span></p>
        <div class="description">
            <p>Thrown if a number argument is not in an acceptable range. This includes the following circumstances:</p>
            <ul>
                <li>An argument representing a length, size, or number of elements is negative (unless a negative value holds special significance in the context of the instruction)</li>
            </ul>
        </div>
        <p><span class="code">indexErr</span> error code = <span class="code">0x04</span></p>
        <div class="description">
            <p>Thrown if an index argument is out of bounds or refers to an invalid item. This includes the following circumstances:</p>
            <ul>
                <li>An index in a frame is out of bounds</li>
                <li>An index in the app data region is out of bounds</li>
                <li>An index in a heap allocation is out of bounds</li>
                <li>An index a function table is out of bounds</li>
            </ul>
        </div>
        <p><span class="code">ptrErr</span> error code = <span class="code">0x05</span></p>
        <div class="description">
            <p>Thrown if a pointer argument has a malformed value, or if the pointer references a deleted heap allocation.</p>
        </div>
        <p><span class="code">nullErr</span> error code = <span class="code">0x06</span></p>
        <div class="description">
            <p>Thrown if a pointer argument has an unexpected null value.</p>
        </div>
        <p><span class="code">dataErr</span> error code = <span class="code">0x07</span></p>
        <div class="description">
            <p>Thrown if an argument data structure contains malformed data. This includes the following circumstances:</p>
            <ul>
                <li>A file position parameter in a bytecode application file has an unexpected value</li>
                <li>A region size parameter in a bytecode application file has an unexpected value</li>
            </ul>
        </div>
        <p><span class="code">argFrameErr</span> error code = <span class="code">0x08</span></p>
        <div class="description">
            <p>Thrown when invoking a function if the next argument frame has invalid size.</p>
        </div>
        <p><span class="code">missingErr</span> error code = <span class="code">0x09</span></p>
        <div class="description">
            <p>Thrown if a necessary resource does not exist. This includes the following circumstances:</p>
            <ul>
                <li>A file required for an operation does not exist</li>
            </ul>
        </div>
        <p><span class="code">stateErr</span> error code = <span class="code">0x0A</span></p>
        <div class="description">
            <p>Thrown when trying to use a resource which is in an invalid state. This includes the following circumstances:</p>
            <ul>
                <li>A file handle required for an operation has been closed</li>
                <li>An application required for an operation is not running</li>
            </ul>
        </div>
        <p><span class="code">permErr</span> error code = <span class="code">0x0B</span></p>
        <div class="description">
            <p>Thrown if the current application has insufficient permissions to perform an action. This includes the following circumstances:</p>
            <ul>
                <li>An application without admin permission tries to access a guarded heap allocation of another application</li>
                <li>An application without admin permission tries to invoke a guarded function of another application</li>
                <li>An application without admin permission tries to access a guarded file</li>
                <li>An application without admin permission tries to give or remove admin permission</li>
                <li>An application without admin permission tries to kill another application</li>
            </ul>
        </div>
        <p><span class="code">capacityErr</span> error code = <span class="code">0x0C</span></p>
        <div class="description">
            <p>Thrown if the system has insufficient hardware resources for the operation. This includes the following circumstances:</p>
            <ul>
                <li>An application tries to create a file when the system volume is full</li>
            </ul>
        </div>
        <p><span class="code">throttleErr</span> error code = <span class="code">0x0D</span></p>
        <div class="description">
            <p>Thrown if the current application should terminate prematurely. This includes the following circumstances:</p>
            <ul>
                <li>An application tries to kill another application</li>
                <li>The system tries to kill an application to free memory</li>
            </ul>
        </div>
{INSTRUCTIONS}
    </body>
</html>


